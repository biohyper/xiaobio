<!DOCTYPE html>
<html>

<head>
    <title>
         密钥--免密SSH互信 - xiaobio 
    </title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Life it self">

    <link rel="stylesheet" type="text/css" href="asset/cuckoo.css">
    <link rel="stylesheet" type="text/css" href="asset/main.css">
    <link rel="stylesheet" type="text/css" href="asset/atom-one-light.css">

    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="xiaobio">

    <script src="asset/highlight.pack.js"></script>
<!--    <script>hljs.initHighlightingOnLoad();</script>-->
</head>

<body>
    <header class="site-header cuckoo">
        <div class="wrapper">
            <a class="site-title" href="index.html">xiaobio</a>
            <nav class="site-nav">
                <a href="#" class="menu-icon">
                    <svg viewBox="0 0 18 15">
                        <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path>
                        <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path>
                        <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path>
                    </svg>
                </a>
                <div class="trigger">
                    
                        <a class="page-link" href="index.html">Home</a>
                    
                        <a class="page-link" href="archives.html">Archives</a>
                    
                        <a class="page-link" href="about.html">About</a>
                    
                </div>
            </nav>
        </div>
    </header>
</body>

</html>
 <div class="page-content cuckoo">
    <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
            <header class="post-header">
                <h1 class="post-title" itemprop="name headline">密钥--免密SSH互信</h1>
                <div class="post-description">
                    
                </div>
            </header>
            <div class="post-content" itemprop="articleBody">
                <h1 id="toc_0">两种SSH免密登录方式</h1>

<p><figure><img src="https://ws3.sinaimg.cn/large/006tNc79ly1g1xdretzc6j31900u0nf1.jpg" alt=""/></figure><br/>
<blockquote class="blockquote-center">面朝大海，春暖花开</blockquote></p>

<span id="more"></span><!-- more -->

<h3 id="toc_1">通过公钥-密钥配对实现</h3>

<p>该方法特别需要注意文件<strong>权限</strong>问题，权限不正确将会导致无法认证成功。</p>

<pre class="line-numbers"><code class="language-text">用户路径权限：755
.ssh权限：700或者744
authorized_keys权限：600
</code></pre>

<h4 id="toc_2">访问端：</h4>

<p>生成公钥和密钥文件，执行命令：<code>ssh-keygen -t rsa</code>生成<code>id_rsa</code>密钥和<code>id_rsa.pub</code>公钥，密钥文件必须保管好，公钥文件可以提供给其他任意服务器。</p>

<p>所以接下来将<code>id_rsa.pub</code>文件通过scp拷贝到其他服务器。</p>

<p>命令集合：<code>ssh-keygen -t rsa;chmod 600 ~/.ssh;scp ~/.ssh/id_dsa.pub user@$ip:/home/user/</code></p>

<h4 id="toc_3">被访问端:</h4>

<p>将<strong>访问端</strong>拷贝过来的<code>id_rsa.pub</code>文件内容追加到本机<code>authorized_keys</code>文件中，以供认证。</p>

<p>命令合集：<code>cat /home/user/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys;chmod 600 ~/.ssh/authorized_keys;chmod 755 /home/user/;chmod 700 /home/user/.ssh;</code></p>

<h3 id="toc_4">通过expect脚本实现</h3>

<blockquote>
<p>注意：</p>

<ol>
<li>脚本文件里边涉及到用户名和密码，所以必须设置好用户的权限，除了用户本人不给其他任何人读取等权限</li>
<li>一般shell脚本可以用sh来执行,<code>expect</code>脚本不能使用<code>sh</code>命令执行，否则会提示文件不可读等报错信息</li>
</ol>
</blockquote>

<p>脚本如下：</p>

<pre class="line-numbers"><code class="language-bash">#！/usr/bin/expect -f    # expect程序可通过whereis查看安装路径
set timeout 10
set id [lindex $argv 0]
set ip 192.168.1.$id
spawn ssh -l user_name@ip
expect {
&quot;yes/no&quot; {send &quot;yes\n&quot;; exp_continue}
&quot;password:&quot; {send &quot;your_password\n&quot;}
}
interact
</code></pre>

<h1 id="toc_5">公钥方法错误汇总</h1>

<p>出现ssh没有达到理想状态，可以通过<code>ssh -vvv remote_username@remote_ip</code>命令查看详细报错信息，参数<code>v</code>越多信息越详细。</p>

<h3 id="toc_6">问题一</h3>

<p>权限问题，报错信息中可以看到<code>Permission Deny</code>的报错，此时可以通过手动修改remote机器的权限，登录到remote机器检查<code>.ssh</code>目录或者<code>authorized_keys</code>权限，执行<code>chmod ~/.ssh 700</code>或者<code>chmod 600 ~/.ssh/authorized_keys</code>修复；<br/>
也可通过<code>ssh-copy-id -i /path/to/id_rsa user_name@remote_ip</code>自动修正权限问题</p>

<h3 id="toc_7">问题二</h3>

<p>查看remote机器文件权限都正常，只有ssh时候还需要密码，报错信息感到异常的有如下内容：</p>

<pre class="line-numbers"><code class="language-text">debug2: we sent a password packet, wait for reply
……
authentications that can continue: publickey,gssapi-keyex,gssapi-with-mic,password
……
we did not send a packet, disable method
</code></pre>

<p>解决办法：<br/>
可以查看<code>/var/log/secure</code>是否有相关信息或者参考该<a href="http://serverfault.com/questions/321534/public-key-authentication-fails-only-when-sshd-is-daemon">文章</a>的解决办法：</p>

<blockquote>
<p>Yes, SELinux is likely the cause. The .ssh dir is probably mislabeled. Look at <code>/var/log/audit/audit.log. It should be labeled ssh_home_t</code>. Check with ls -laZ. Run <code>restorecon -r -vv /root/.ssh</code> if need be</p>
</blockquote>

<p>不错这次错误中没有看到如下信息：<br/>
<code>/var/log/audit/audit.log. It should be labeled ssh_home_t</code></p>

<h1 id="toc_8">集群中ssh公钥免密登录脚本</h1>

<p>引自博客园<a href="http://www.cnblogs.com/vovlie/archive/2012/09/16/2688020.html">记录</a>，在此感谢。</p>

<p>假设有一个1000台节点的Hadoop集群，要配置节点之间的SSH免密码登录，该如何用shell脚本实现？</p>

<h3 id="toc_9">循环1000台机器的IP地址，生成密钥文件authorized_keys</h3>

<pre class="line-numbers"><code class="language-bash">#!/bin/expect
#循环1000台机器的IP地址，生成密钥文件authorized_keys

for ip in {cat ip.list}

do

    ssh user@$ip ssh-keygen -t rsa  &amp;&gt;/dev/null

    expect{

                &quot;yes/no&quot; { send &quot;yes\r&quot;;exp_continue}

                &quot;password:&quot;{send &quot;$passwd\r&quot;;exp_continue}

              }

    cat ~/.ssh/id_rsa.pub &gt; ~/.ssh/authorized_keys &amp;&gt; /dev/null 

    exit

    if [ !-f ~/.ssh/authorized_keys ];
    then

       touch ~/.ssh/authorized_keys
    fi

    ssh user@$ip cat ~/.ssh/authorized_keys &gt;&gt; ~/.ssh/authorized_keys  &amp;&gt; /dev/null

    expect{

                &quot;yes/no&quot; { send &quot;yes\r&quot;;exp_continue}

                &quot;password:&quot;{send &quot;$passwd\r&quot;;exp_continue}

              }  

done
</code></pre>

<h3 id="toc_10">拷贝authorized_keys文件到各台机器上面</h3>

<pre class="line-numbers"><code class="language-bash">#scp authorized_keys 文件到各台机器上面

for ip in {cat ip.list}

do

   scp ~/.ssh/authorized_keys user@$ip:~/.ssh/

    expect{

                &quot;yes/no&quot; { send &quot;yes\r&quot;;exp_continue}

                &quot;password:&quot;{send &quot;$passwd\r&quot;;exp_continue}

              } 

done
</code></pre>

            </div>
            <div>
                
                
                
            </div>
        </article>
    </div>
</div>

<script src="asset/jquery-3.3.1.min.js"></script>

<script>
    $(document).ready(function() {
        $('#footer').show()
    })
</script>
  <footer id="footer" class="cuckoo page-footer" style="display: none">
    <div class="wrapper">
        <p>Designed and Written by <a href="mailto:forrestchang7@gmail.com">Jiayuan Zhang</a></p>
    </div>
</footer>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

